## 变更记录（按与助手的交互阶段）

### 阶段一：实现模块一（文件IO与场景初始化）
- 新增文件：`index.html`、`src/main.js`、`src/ui.js`
- 主要调整：
  - 集成 Three.js 场景、相机、灯光、`OrbitControls`
  - 支持加载本地 `.stl`（`STLLoader` 解析、居中、法线计算、透明材质）
  - 导入/导出 `.json`（点集数据）
  - 牙模透明度滑块控制，仅影响网格材质
- 已完成功能：
  - 基础UI与项目骨架
  - 模型加载、镜头控制、JSON IO、透明度调节

### 阶段二：实现模块二与模块三（参考平面与路径设计）
- 更新 `index.html`：新增参考平面与路径设计的UI区块
- 更新 `src/main.js`：
  - 参考平面：三点点选、拖拽（`DragControls`）、法向计算、`PlaneGeometry`可视化、显隐切换
  - 路径设计：
    - 绘制模式：点击牙模添加点，依据面法线外偏移弓丝半径
    - 编辑模式：拖拽红点实时更新路径
  - **导入导出功能增强**：
    - 导出JSON时包含参考平面数据（控制点位置、法线、平面位置、可见性状态）
    - 导入JSON时自动恢复参考平面状态，包括控制点、法线方向和可见性
    - 支持向后兼容：旧版本JSON文件（仅包含路径点）仍可正常导入
    - 曲线渲染：直线（`CurvePath` + `LineCurve3`）/ 平滑（`CatmullRomCurve3`）+ `TubeGeometry`
    - 清除全部
- 已完成功能：
  - 参考平面定义与确认
  - 路径绘制、编辑、曲线渲染与清空

### 阶段三：实现模块四（U型曲生成）与模块六（撤销）
- 更新 `index.html`：
  - 新增按钮：`生成U型曲`、`撤销（Ctrl+Z）`
  - 提示：编辑模式下 `Shift` + 单击选择两个端点
- 更新 `src/main.js`：
  - 点选择：编辑模式下按 `Shift` + 单击点作为端点选择/取消；超过两个自动替换最早选择
  - U型曲生成：
    - 基于参考平面法向与端点方向确定朝向
    - 生成两臂与半圆顶（中间隐点不可见/不可拖拽）
    - 替换端点之间的原有路径段
  - 撤销：
    - 保存历史（加点、拖拽、清空、生成U型曲、导入）
    - 支持按钮与 `Ctrl+Z` 撤销
- 已完成功能：
  - U型曲交互生成
  - 稳定的历史栈与撤销机制

### 阶段四：参数化与规范细化（依据《唇弓矫正器设计说明》）
- 更新 `index.html`：
  - 新增“参数设置”模态框（路径设计标题右侧齿轮按钮）
  - 可调参数：弓丝直径、点直径、U型曲宽度/高度/末端离组织面距离
- 更新 `src/main.js`：
  - 参数管理：装载/保存（`localStorage` 持久化）、显示/隐藏模态、应用与重绘
  - U型曲算法优化：

### 阶段五：U型曲生成逻辑优化
- 更新 `src/main.js`：
  - 修改U型曲生成机制：从基于参考平面改为基于三个点（两端和最底部端点）
  - 选择机制更新：支持选择三个点而非两个点，三个点使用不同颜色标识
  - 添加中间点颜色标识（橙色），区分起点/终点（紫色）
  - 新增 `generateULoopFromThreePoints` 函数：
    - 根据三个点计算平面法线
    - 计算U型曲高度（从起点-终点连线到最低点的实际距离）
    - 在三个点确定的平面内生成U型曲
  - 修改 `generateULoopFromSelection` 函数：使用三个选择的点进行U型曲生成
- 优化用户体验：
  - 生成U型曲按钮仅在选择三个点后可用
  - 保持用户选择的三个点的顺序（起点、中间点、终点）
    - 宽度不超过端点距离80%，避免几何异常
    - 末端按法向偏移满足组织面距离要求
- 已完成功能：
  - 可视化参数面板与持久化
  - 规范化U型曲生成（宽度/高度/末端距离）

### 阶段六：接触点模式实现
- 更新 `index.html`：
  - 在设计模式选择器中新增"接触点模式"选项
  - 更新提示文本，说明接触点模式的使用方法
- 更新 `src/main.js`：
  - 新增接触点模式相关变量和状态管理
  - 实现 `calculateContactPoints` 函数：
    - 计算参考平面与模型的接触点
    - 使用容差检测和聚类算法优化接触点显示
    - 自动生成绿色小球标记接触点
  - 实现接触点选择功能：
    - 支持点击选择两个接触点作为起点和终点
    - 选中点变为橙色，提供视觉反馈
    - 支持取消选择和重新选择
  - 实现路径生成功能：
    - `generatePathFromContactPoints`：基于选定的两个接触点生成路径
    - `calculatePlaneModelIntersection`：计算参考平面与模型的交线
    - `generateSmoothPath`：使用CatmullRom曲线生成平滑路径
  - 集成到现有UI和工作流程中
- 新增文件：
  - `接触点模式使用说明.md`：详细的使用说明文档
- 已完成功能：
  - 接触点自动检测和可视化
  - 两点选择交互
  - 平滑路径自动生成
  - 完整的用户界面集成

### 阶段七：接触点模式路径生成优化
- 修复路径生成算法：
  - 改进接触点排序：按照在参考平面上的角度位置排序
  - 实现短曲线选择：计算两点间的两个方向距离，自动选择较短的方向
  - 均匀采样：在短曲线中均匀选择6-10个点作为路径点
  - 优化路径生成：使用排序后的接触点确保正确的曲线顺序
- 更新文档：
  - 更新使用说明，反映新的路径生成逻辑
  - 更新工作流程文档，说明技术实现细节
- 已完成功能：
  - 修复"无法生成路径：未找到有效的交线"错误
  - 实现正确的短曲线路径生成
  - 确保路径点数量在6-10个之间

### 阶段八：接触点模式路径生成进一步优化
- 修复路径生成问题：
  - 直接使用接触点作为路径点，不再重新计算
  - 确保生成的路径点都在参考平面上
  - 限制路径点数量在10个左右，避免过多点
- 代码优化：
  - 删除不再需要的 `calculatePlaneModelIntersection` 函数
  - 删除不再需要的 `findClosestSurfacePoint` 函数
  - 删除不再需要的 `generateSmoothPath` 函数
  - 新增 `limitPathPoints` 函数控制点数量
- 更新文档：
  - 更新使用说明，反映直接使用接触点的逻辑
  - 更新工作流程文档，说明点数量限制
- 已完成功能：
  - 修复路径点不在参考平面上的问题
  - 控制路径点数量在合理范围内
  - 简化路径生成算法，提高效率

### 阶段九：接触点模式路径生成最终优化
- 修复路径生成问题：
  - 改进接触点排序：按照在参考平面与模型交线上的实际位置排序
  - 新增 `sortContactPointsByIntersectionCurve` 函数：基于交线中心点进行角度排序
  - 新增 `sortPointsAlongCurve` 函数：沿着曲线对路径点进行排序
  - 确保路径沿着模型轮廓，而不是直线连接
- 算法优化：
  - 使用交线中心点作为排序基准
  - 按照累积距离对路径点进行排序
  - 确保路径点按照在曲线上的实际位置排列
- 更新文档：
  - 更新使用说明，反映新的排序逻辑
  - 更新工作流程文档，说明曲线排序算法
- 已完成功能：
  - 修复路径不沿着模型轮廓的问题
  - 确保路径点按照正确的顺序排列
  - 生成符合期望的曲线路径

### 阶段十：接触点模式TSP排序和平滑曲线优化
- 修复接触点排序问题：
  - 实现TSP最短路径算法：`sortContactPointsByTSP` 函数
  - 使用贪心算法确保首尾相连的路径最短
  - 替换角度排序，使用距离最短的排序方式
- 修复路径生成问题：
  - 确保起点和终点都包含在生成的路径中
  - 新增 `generateSmoothCurve` 函数：使用CatmullRom曲线生成平滑路径
  - 限制控制点数量在10个左右，生成包含更多点的平滑曲线
- 算法优化：
  - 使用TSP算法确保接触点按照最短路径排序
  - 确保路径包含选定的起点和终点
  - 生成真正的平滑曲线而不是折线
- 更新文档：
  - 更新使用说明，反映TSP排序和平滑曲线生成
  - 更新工作流程文档，说明新的算法实现
- 已完成功能：
  - 修复终点不包含在路径中的问题
  - 实现真正的平滑曲线路径生成
  - 确保路径按照最短路径方式生成

### 阶段十一：接触点模式参数控制优化
- 新增参数控制功能：
  - 在参数设置中添加"控制点数量"控制（3-20个）
  - 在参数设置中添加"平滑曲线点数"控制（20-200个）
  - 支持用户自定义路径生成参数
- 更新UI界面：
  - 在设置模态框中添加两个新的输入控件
  - 添加参数验证和范围限制
  - 更新参数加载和保存逻辑
- 代码优化：
  - 新增 `controlPointsCount` 和 `smoothPointsCount` 参数变量
  - 更新 `limitPathPoints` 函数使用可配置的控制点数量
  - 更新 `generateSmoothCurve` 函数使用可配置的平滑曲线点数
- 更新文档：
  - 更新使用说明，添加参数设置使用指南
  - 更新技术实现说明，反映参数控制功能
- 已完成功能：
  - 实现用户可配置的控制点数量
  - 实现用户可配置的平滑曲线点数
  - 参数持久化存储和自动加载

### 文件清单（关键）
- `index.html`：页面与所有UI、参数模态
- `src/main.js`：Three.js场景、参考平面、路径交互、U型曲、撤销、参数化、接触点模式
- `src/ui.js`：UI工具占位（为后续扩展保留）
- `接触点模式使用说明.md`：接触点模式详细使用说明

### 使用提示
1. 加载STL → 设置并确认参考平面
2. 路径设计：绘制点或编辑点
3. 编辑模式下 `Shift+单击` 选择三个端点 → 生成U型曲
4. 接触点模式：选择"接触点模式" → 点击两个接触点 → 自动生成路径
5. 点击设置图标调整参数（自动保存）
6. 需要回退可按 `Ctrl+Z` 或点击"撤销"
